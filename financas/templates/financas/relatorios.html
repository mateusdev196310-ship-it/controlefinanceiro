{% extends 'financas/base.html' %}
{% load static %}
{% load currency_filters %}
{% load categoria_tags %}

{% block title %}Relatórios{% endblock %}
{% block page_title %}Relatórios{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>Relatório Geral</h2>
    </div>
</div>

<!-- Filtros de Período e Tipo de Exibição -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3 bg-light">
                <h6 class="m-0 font-weight-bold text-primary">Filtros de Relatório</h6>
            </div>
            <div class="card-body">
                <form method="GET" id="filtroForm">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="periodo" class="form-label">Período:</label>
                            <select class="form-control" id="periodo" name="periodo">
                                <option value="mes_atual" {% if periodo == 'mes_atual' %}selected{% endif %}>Mês Atual</option>
                                <option value="ultimos_30_dias" {% if periodo == 'ultimos_30_dias' %}selected{% endif %}>Últimos 30 Dias</option>
                                <option value="semana_atual" {% if periodo == 'semana_atual' %}selected{% endif %}>Semana Atual</option>
                                <option value="hoje" {% if periodo == 'hoje' %}selected{% endif %}>Hoje</option>
                                <option value="personalizado" {% if periodo == 'personalizado' %}selected{% endif %}>Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="tipo_exibicao" class="form-label">Tipo de Exibição:</label>
                            <select class="form-control" id="tipo_exibicao" name="tipo_exibicao">
                                <option value="mensal" {% if tipo_exibicao == 'mensal' %}selected{% endif %}>Mensal</option>
                                <option value="diario" {% if tipo_exibicao == 'diario' %}selected{% endif %}>Diário</option>
                                <option value="semanal" {% if tipo_exibicao == 'semanal' %}selected{% endif %}>Semanal</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-3">Aplicar Filtros</button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="limparFiltros()">Limpar</button>
                        </div>
                    </div>
                    <div class="row mt-3" id="periodo_personalizado" style="display: {% if periodo == 'personalizado' %}block{% else %}none{% endif %};">
                        <div class="col-md-6">
                            <label for="data_inicio" class="form-label">Data Início:</label>
                            <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio }}">
                        </div>
                        <div class="col-md-6">
                            <label for="data_fim" class="form-label">Data Fim:</label>
                            <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim }}">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Cards de resumo com design antigo -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Total de Receitas
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_receitas|currency_br }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-arrow-up fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Total de Despesas
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_despesas|currency_br }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-arrow-down fa-2x text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Saldo do Mês
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ saldo|currency_br }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-wallet fa-2x text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Gráficos -->
<div class="row mb-4">
    <!-- Gráfico de Evolução do Saldo -->
    <div class="col-md-6">
        <div class="card shadow mb-4" style="height: 450px;">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold">Gráfico de Evolução do Saldo</h6>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center" style="height: calc(100% - 60px);">
                <div class="chart-area" style="width: 100%; height: 100%; max-height: 350px;">
                    <canvas id="saldoChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Barras Horizontais por Categoria -->
    <div class="col-md-6">
        <div class="card shadow mb-4" style="height: 450px;">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold">Despesas por Categoria</h6>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center" style="height: calc(100% - 60px);">
                <div class="chart-bar" style="width: 100%; height: 100%; max-height: 350px;">
                    <canvas id="categoriaChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Resumo -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4" style="max-height: 500px;">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold">Resumo por Categoria</h6>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-striped table-sm">
                        <thead class="thead-light" style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fc;">
                            <tr>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for categoria in dados_categorias %}
                            <tr>
                                <td>
                                    {% categoria_badge categoria.nome categoria.cor %}
                                </td>
                                <td class="font-weight-bold">{{ categoria.valor|currency_br }}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: {{ categoria.percentual }}%" aria-valuenow="{{ categoria.percentual }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ categoria.percentual }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">Nenhuma despesa encontrada</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gráfico de barras horizontais para categorias
const ctx = document.getElementById('categoriaChart').getContext('2d');

// Dados das categorias ordenados do maior para menor valor
let categoriasData = [
    {% for categoria in dados_categorias %}
    { nome: '{{ categoria.nome }}', valor: {{ categoria.valor }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Ordenar do maior para menor valor
categoriasData.sort((a, b) => b.valor - a.valor);

// Função para formatar valores em reais
function formatarReal(valor) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(valor);
}

const categoriaChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: categoriasData.map(item => item.nome),
        datasets: [{
            label: 'Valor (R$)',
            data: categoriasData.map(item => item.valor),
            backgroundColor: [
                '#e74a3b',
                '#3498db', 
                '#f39c12',
                '#2ecc71',
                '#9b59b6',
                '#1abc9c',
                '#e67e22',
                '#34495e'
            ],
            borderColor: [
                '#c0392b',
                '#2980b9',
                '#d68910',
                '#27ae60',
                '#8e44ad',
                '#16a085',
                '#d35400',
                '#2c3e50'
            ],
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + formatarReal(context.parsed.x);
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return formatarReal(value);
                    }
                }
            }
        }
    }
});

// Gráfico de linha para evolução do saldo
const saldoCtx = document.getElementById('saldoChart').getContext('2d');

// Verificar se há dados reais para exibir
{% if dados_evolucao %}
const balanceData = {
    labels: [{% for item in dados_evolucao %}'{{ item.data }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    values: [{% for item in dados_evolucao %}{{ item.saldo }}{% if not forloop.last %},{% endif %}{% endfor %}]
};
{% else %}
// Sem dados para exibir
const balanceData = {
    labels: [],
    values: []
};
{% endif %}

const saldoChart = new Chart(saldoCtx, {
    type: 'line',
    data: {
        labels: balanceData.labels,
        datasets: [{
            label: 'Evolução do Saldo',
            data: balanceData.values,
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#4e73df',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#4e73df',
                borderWidth: 1,
                callbacks: {
                    label: function(context) {
                        return 'Saldo: R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                ticks: {
                    color: '#858796',
                    font: {
                        size: 12
                    },
                    callback: function(value) {
                        return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                },
                grid: {
                    color: 'rgba(0,0,0,0.1)',
                    drawBorder: false
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#858796',
                    font: {
                        size: 12
                    }
                }
            }
        },
        elements: {
            point: {
                hoverBackgroundColor: '#4e73df'
            }
        }
    }
});

// Funções para controle dos filtros
function limparFiltros() {
    document.getElementById('periodo').value = 'mes_atual';
    document.getElementById('tipo_exibicao').value = 'mensal';
    document.getElementById('data_inicio').value = '';
    document.getElementById('data_fim').value = '';
    document.getElementById('periodo_personalizado').style.display = 'none';
    document.getElementById('filtroForm').submit();
}

// Mostrar/ocultar campos de período personalizado
document.getElementById('periodo').addEventListener('change', function() {
    const periodoPersonalizado = document.getElementById('periodo_personalizado');
    if (this.value === 'personalizado') {
        periodoPersonalizado.style.display = 'block';
    } else {
        periodoPersonalizado.style.display = 'none';
    }
});
</script>
{% endblock %}