{% extends 'financas/base.html' %}
{% load static %}
{% load currency_filters %}

{% block page_title %}Detalhes da Despesa Parcelada{% endblock %}

{% block extra_css %}
<style>
    /* Responsividade melhorada - Layout limpo e proporcional */
    @media (max-width: 768px) {
        /* Container principal */
        .container-fluid {
            padding: 0.5rem !important;
        }
        
        /* Cards principais */
        .card {
            margin-bottom: 1rem !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .card-body {
            padding: 1rem !important;
        }
        
        /* Título da despesa - sempre visível */
        .card-body .text-center h4.text-primary,
        .text-center h4.text-primary,
        h4.text-primary {
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            color: #0d6efd !important;
            margin-bottom: 1rem !important;
            padding: 0.75rem !important;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%) !important;
            border-radius: 0.5rem !important;
            border-left: 4px solid #0d6efd !important;
            text-align: center !important;
            line-height: 1.4 !important;
        }
        
        /* Cards de valores (Valor Total e Por Parcela) - lado a lado */
        .card-body .row.mb-3.g-2 {
            display: flex !important;
            flex-wrap: nowrap !important;
            gap: 0.75rem !important;
            margin-bottom: 1.5rem !important;
        }
        
        .card-body .row.mb-3.g-2 .col-6 {
            flex: 1 !important;
            margin-bottom: 0 !important;
            padding: 0 !important;
        }
        
        .card-body .row.mb-3.g-2 .col-6 .border-end,
        .card-body .row.mb-3.g-2 .col-6 .p-2 {
            padding: 1rem !important;
            text-align: center !important;
            min-height: 5rem !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            transition: all 0.2s ease !important;
        }
        
        .card-body .row.mb-3.g-2 .col-6 .border-end:hover,
        .card-body .row.mb-3.g-2 .col-6 .p-2:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
        }
        
        /* Valores dos cards */
        .card-body .row.mb-3.g-2 h3,
        .card-body .row.mb-3.g-2 h4 {
            font-size: 1.2rem !important;
            font-weight: 700 !important;
            margin-bottom: 0.25rem !important;
            color: #212529 !important;
        }
        
        .card-body .row.mb-3.g-2 small {
            font-size: 0.85rem !important;
            font-weight: 500 !important;
            color: #6c757d !important;
        }
        
        /* Informações gerais - layout organizado */
        .card-body .info-item {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0.75rem !important;
            margin-bottom: 0.5rem !important;
            background-color: #f8f9fa !important;
            border-radius: 0.375rem !important;
            border-left: 3px solid #0d6efd !important;
        }
        
        .card-body .info-item:nth-child(odd) {
            background-color: #ffffff !important;
            border-left: 3px solid #6c757d !important;
        }
        
        .card-body .info-item .info-label {
            font-size: 0.9rem !important;
            font-weight: 500 !important;
            color: #495057 !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
        }
        
        .card-body .info-item .info-value {
            font-size: 0.95rem !important;
            font-weight: 600 !important;
            color: #212529 !important;
            text-align: right !important;
        }
        
        /* Ícones nas informações */
        .card-body .info-item .info-label i {
            width: 1.2rem !important;
            text-align: center !important;
            color: #0d6efd !important;
        }
    }
    
    @media (max-width: 576px) {
        /* Container ainda mais compacto */
        .container-fluid {
            padding: 0.25rem !important;
        }
        
        .card-body {
            padding: 0.75rem !important;
        }
        
        /* Título mais compacto em telas pequenas */
        .card-body .text-center h4.text-primary,
        .text-center h4.text-primary,
        h4.text-primary {
            font-size: 1rem !important;
            padding: 0.5rem !important;
            margin-bottom: 0.75rem !important;
        }
        
        /* Cards de valores ainda menores mas lado a lado */
        .card-body .row.mb-3.g-2 {
            display: flex !important;
            flex-wrap: nowrap !important;
            gap: 0.5rem !important;
            margin-bottom: 1rem !important;
        }
        
        .card-body .row.mb-3.g-2 .col-6 {
            flex: 1 !important;
        }
        
        .card-body .row.mb-3.g-2 .col-6 .border-end,
        .card-body .row.mb-3.g-2 .col-6 .p-2 {
            padding: 0.75rem 0.5rem !important;
            min-height: 4rem !important;
        }
        
        .card-body .row.mb-3.g-2 h3,
        .card-body .row.mb-3.g-2 h4 {
            font-size: 1.1rem !important;
        }
        
        .card-body .row.mb-3.g-2 small {
            font-size: 0.8rem !important;
        }
        
        /* Informações mais compactas */
        .card-body .info-item {
            padding: 0.5rem !important;
            margin-bottom: 0.4rem !important;
        }
        
        .card-body .info-item .info-label {
            font-size: 0.85rem !important;
        }
        
        .card-body .info-item .info-value {
            font-size: 0.9rem !important;
        }
        
        /* Resumo estatístico em duas colunas para telas pequenas */
        .card .card-header h6 {
            font-size: 0.9rem !important;
            text-align: center !important;
        }
        
        .card .card-body .row.text-center:first-child {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
            margin-bottom: 1rem !important;
        }
        
        .card .card-body .row.text-center:first-child .col-md-3 {
            flex: 0 0 calc(50% - 0.25rem) !important;
            max-width: calc(50% - 0.25rem) !important;
            margin-bottom: 0.5rem !important;
            padding: 0.75rem 0.5rem !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
            border-radius: 0.375rem !important;
            border: 1px solid #dee2e6 !important;
        }
        
        .card .card-body .row.text-center:last-child {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
        }
        
        .card .card-body .row.text-center:last-child .col-md-4 {
            flex: 0 0 calc(50% - 0.25rem) !important;
            max-width: calc(50% - 0.25rem) !important;
            margin-bottom: 0.5rem !important;
            padding: 0.75rem 0.5rem !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
            border-radius: 0.375rem !important;
            border: 1px solid #dee2e6 !important;
        }
        
        .card .card-body .row.text-center:last-child .col-md-4:last-child {
            flex: 0 0 100% !important;
            max-width: 100% !important;
        }
        
        /* Cards de valores lado a lado melhorados */
        .card-body .row.mb-3.g-2 {
            display: flex !important;
            flex-wrap: nowrap !important;
            gap: 0.5rem !important;
        }
        
        .card-body .row.mb-3.g-2 .col-6 {
            flex: 1 !important;
        }
        
        /* Informações gerais lado a lado */
        .card-body .info-item {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0.75rem 1rem !important;
            margin-bottom: 0.5rem !important;
            background: #f8f9fa !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
        }
        
        .card-body .info-item:hover {
            background: #e9ecef !important;
            transform: translateY(-1px) !important;
        }
        
        .card-body .info-item .info-label {
            display: flex !important;
            align-items: center !important;
            font-weight: 500 !important;
        }
        
        .card-body .info-item .info-label i {
            margin-right: 0.5rem !important;
            color: #6c757d !important;
        }
        
        .card-body .info-item .info-value {
            font-weight: 600 !important;
            color: #495057 !important;
        }
        
        /* Ajustar fontes do resumo */
        .card .card-body h4 {
            font-size: 0.95rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        .card .card-body h5 {
            font-size: 0.9rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        .card .card-body small {
            font-size: 0.75rem !important;
        }
        
        .card .card-body .fa-2x {
            font-size: 1.2rem !important;
            margin-bottom: 0.25rem !important;
        }
         .card .card-body .fa-2x {
             font-size: 1.25rem !important;
             margin-bottom: 0.5rem !important;
         }
     }
    

    
    @media (max-width: 576px) {
        /* Cards de valores lado a lado em mobile */
        .card-body .row.mb-3.g-2 {
            display: flex !important;
            flex-wrap: nowrap !important;
            gap: 0.25rem !important;
        }
        
        .card-body .row.mb-3.g-2 .col-6 {
            flex: 1 !important;
        }
        
        /* Manter cores dos valores em mobile */
        .card-body .row.mb-3.g-2 h3.text-success {
            color: #198754 !important;
            font-size: 1.5rem !important;
        }
        
        .card-body .row.mb-3.g-2 h4.text-primary {
            color: #0d6efd !important;
            font-size: 1.3rem !important;
        }
        
        /* Informações gerais compactas */
        .card-body .info-item {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0.5rem 0.75rem !important;
            margin-bottom: 0.5rem !important;
            font-size: 0.9rem !important;
            background: #f8f9fa !important;
            border-radius: 8px !important;
        }
        
        .card-body .info-item .info-label {
            display: flex !important;
            align-items: center !important;
            font-weight: 500 !important;
        }
        
        .card-body .info-item .info-label span {
            display: inline !important;
        }
        
        .card-body .info-item .info-value {
            font-weight: 600 !important;
            color: #495057 !important;
        }
        
        .card-body .info-item .info-value span {
            display: inline !important;
        }
        
        /* Resumo estatístico em duas colunas */
        .card .card-body .row.text-center {
            display: flex !important;
            flex-wrap: wrap !important;
        }
        
        .card .card-body .row.text-center .col-md-3,
        .card .card-body .row.text-center .col-md-4 {
            flex: 0 0 50% !important;
            max-width: 50% !important;
            margin-bottom: 1rem !important;
            padding: 0.5rem !important;
        }
        
        /* Ajustar tamanhos de fonte */
        .card .card-body h4 {
            font-size: 1.5rem !important;
        }
        
        .card .card-body h5 {
            font-size: 0.9rem !important;
        }
        
        /* Garantir que as descrições apareçam em mobile */
        .card .card-body .row.text-center small {
            display: block !important;
            font-size: 0.75rem !important;
            color: #6c757d !important;
            margin-top: 0.25rem !important;
        }
        
        .card .card-body .row.text-center .text-muted {
            display: block !important;
            font-size: 0.75rem !important;
        }
        
        /* Garantir que as descrições apareçam */
        .card .card-body .row.text-center small {
            display: block !important;
            font-size: 0.8rem !important;
            color: #6c757d !important;
        }
        
        .card .card-body .row.text-center h4,
        .card .card-body .row.text-center h5 {
            margin-bottom: 0.25rem !important;
        }
    }
     
     @media (max-width: 400px) {
        .card-body {
            padding: 0.75rem 0.5rem;
        }
        
        /* Manter cores e tamanhos dos valores em telas muito pequenas */
        .card-body .row.mb-3.g-2 h3.text-success {
            color: #198754 !important;
            font-size: 1.3rem !important;
        }
        
        .card-body .row.mb-3.g-2 h4.text-primary {
            color: #0d6efd !important;
            font-size: 1.1rem !important;
        }
        
        .card-body .text-muted {
            font-size: 0.8rem;
        }
        
        .card-body .fw-bold {
            font-size: 0.85rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-credit-card me-2"></i>
            Detalhes da Despesa Parcelada
        </h2>
        <div>
            <a href="{% url 'despesas_parceladas' %}" class="btn btn-secondary me-2">
                <i class="fas fa-arrow-left me-1"></i>
                Voltar
            </a>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="fas fa-trash me-1"></i>
                Excluir Despesa
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- Informações Gerais -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações Gerais
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h4 class="text-primary">{{ despesa.descricao }}</h4>
                        <span class="badge fs-6" style="background-color: {{ despesa.categoria.cor }}; color: white;">
                            {{ despesa.categoria.nome }}
                        </span>
                    </div>
                    
                    <div class="row mb-3 g-2">
                        <div class="col-6 text-center">
                            <div class="border-end p-2">
                                <h3 class="text-success mb-1">{{ despesa.valor_total|currency_br }}</h3>
                                <small class="text-muted d-block">Valor Total</small>
                            </div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="p-2">
                                <h4 class="text-primary mb-1">{{ despesa.valor_parcela|currency_br }}</h4>
                                <small class="text-muted d-block">Por Parcela</small>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <div class="info-item mb-2 p-2 rounded bg-light">
                            <div class="info-label">
                                <i class="fas fa-list-ol me-1"></i>
                                <span class="text-muted">Parcelas:</span>
                            </div>
                            <div class="info-value">
                                <span class="fw-bold text-primary">{{ despesa.numero_parcelas }}x</span>
                            </div>
                        </div>
                        
                        <div class="info-item mb-2 p-2 rounded">
                            <div class="info-label">
                                <i class="fas fa-clock me-1"></i>
                                <span class="text-muted">Intervalo:</span>
                            </div>
                            <div class="info-value">
                                <span class="fw-bold text-info">{{ despesa.get_intervalo_tipo_display }}</span>
                            </div>
                        </div>
                        
                        <div class="info-item mb-2 p-2 rounded bg-light">
                            <div class="info-label">
                                <i class="fas fa-calendar-alt me-1"></i>
                                <span class="text-muted">Primeira Parcela:</span>
                            </div>
                            <div class="info-value">
                                <span class="fw-bold text-success">{{ despesa.data_primeira_parcela|date:"d/m/Y" }}</span>
                            </div>
                        </div>
                        
                        {% if despesa.responsavel %}
                            <div class="info-item mb-2 p-2 rounded">
                                <div class="info-label">
                                    <i class="fas fa-user me-1"></i>
                                    <span class="text-muted">Responsável:</span>
                                </div>
                                <div class="info-value">
                                    <span class="fw-bold text-dark">{{ despesa.responsavel }}</span>
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="info-item p-2 rounded bg-light">
                            <div class="info-label">
                                <i class="fas fa-calendar-plus me-1"></i>
                                <span class="text-muted">Criada em:</span>
                            </div>
                            <div class="info-value">
                                <span class="fw-bold text-secondary">{{ despesa.criada_em|date:"d/m/Y H:i" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    {% if parcelas_recem_geradas %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i>
                            Parcelas geradas com sucesso
                        </div>
                    {% elif not despesa.parcelas_geradas %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Parcelas não foram geradas
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Lista de Parcelas -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Parcelas Geradas
                        </h5>
                        {% if parcelas %}
                            <span class="badge bg-light text-dark">
                                {{ parcelas.count }} parcela{{ parcelas.count|pluralize }}
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if parcelas %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center">
                                            <i class="fas fa-hashtag me-1"></i>
                                            Parcela
                                        </th>
                                        <th>
                                            <i class="fas fa-calendar me-1"></i>
                                            Vencimento
                                        </th>
                                        <th class="text-end">
                                            <i class="fas fa-dollar-sign me-1"></i>
                                            Valor
                                        </th>
                                        <th class="text-center">
                                            <i class="fas fa-flag me-1"></i>
                                            Status
                                        </th>
                                        <th>
                                            <i class="fas fa-user me-1"></i>
                                            Responsável
                                        </th>
                                        <th class="text-center">
                                            <i class="fas fa-credit-card me-1"></i>
                                            Pagamento
                                        </th>
                                        <th class="text-center">
                                            <i class="fas fa-cogs me-1"></i>
                                            Ações
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for parcela in parcelas %}
                                        <tr class="{% if parcela.data < today %}table-danger{% elif parcela.data == today %}table-warning{% endif %}">
                                            <td class="text-center">
                                                <span class="badge bg-primary">
                                                    {{ parcela.numero_parcela }}/{{ parcela.total_parcelas }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">{{ parcela.data|date:"d/m/Y" }}</span>
                                                <br>
                                                <small class="text-muted">{{ parcela.data|date:"l" }}</small>
                                            </td>
                                            <td class="text-end">
                                                <span class="h6 text-success mb-0">
                                                    {{ parcela.valor|currency_br }}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                {% if parcela.data < today %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        Vencida
                                                    </span>
                                                {% elif parcela.data == today %}
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="fas fa-clock me-1"></i>
                                                        Vence Hoje
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>
                                                        A Vencer
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if parcela.responsavel %}
                                                    <span class="fw-bold">{{ parcela.responsavel }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if parcela.pago %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>
                                                        Pago
                                                    </span>
                                                    {% if parcela.data_pagamento %}
                                                        <br><small class="text-muted">{{ parcela.data_pagamento|date:"d/m/Y" }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="fas fa-clock me-1"></i>
                                                        Pendente
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group" role="group">
                                                    {% if parcela.pago %}
                                                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                                                onclick="confirmarReabertura({{ parcela.id }}, '{{ parcela.descricao }}')" 
                                                                title="Marcar como não pago">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    {% else %}
                                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                                onclick="abrirModalPagamento({{ parcela.id }}, '{{ parcela.descricao }}', {{ parcela.valor }})" 
                                                                title="Marcar como pago">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                            </div>
                            <h5 class="text-muted mb-2">Nenhuma parcela encontrada</h5>
                            <p class="text-muted mb-3">
                                As parcelas podem não ter sido geradas corretamente.<br>
                                Verifique se o processo de criação foi concluído.
                            </p>
                            <button class="btn btn-warning" onclick="gerarParcelas({{ despesa.id }})">
                                <i class="fas fa-sync-alt me-1"></i>
                                Tentar Gerar Parcelas
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    {% if parcelas %}
        <!-- Resumo Estatístico -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            Resumo Estatístico
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h4 class="text-primary mb-1">{{ parcelas.count }}</h4>
                                    <small class="text-muted">Total de Parcelas</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h4 class="text-success mb-1">{{ despesa.valor_total|currency_br }}</h4>
                                    <small class="text-muted">Valor Total</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h4 class="text-info mb-1">{{ despesa.valor_parcela|currency_br }}</h4>
                                    <small class="text-muted">Valor por Parcela</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-warning mb-1">{{ despesa.get_intervalo_tipo_display }}</h4>
                                <small class="text-muted">Intervalo</small>
                            </div>
                        </div>
                        
                        <hr class="my-3">
                        
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="text-success">
                                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                                    <h5>{{ despesa.get_parcelas_pagas.count }}</h5>
                                    <small>Pagas</small>
                                    <div class="mt-1">
                                        <small class="text-muted">{{ despesa.get_valor_pago|currency_br }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-warning">
                                    <i class="fas fa-clock fa-2x mb-2"></i>
                                    <h5>{{ despesa.get_parcelas_pendentes.count }}</h5>
                                    <small>Pendentes</small>
                                    <div class="mt-1">
                                        <small class="text-muted">{{ despesa.get_valor_pendente|currency_br }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-info">
                                    <i class="fas fa-percentage fa-2x mb-2"></i>
                                    <h5>{% widthratio despesa.get_parcelas_pagas.count despesa.get_parcelas.count 100 %}%</h5>
                                    <small>Progresso</small>
                                    <div class="mt-1">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {% widthratio despesa.get_parcelas_pagas.count despesa.get_parcelas.count 100 %}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-trash fa-3x text-danger mb-3"></i>
                    <h5>Tem certeza que deseja excluir esta despesa parcelada?</h5>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Atenção:</strong> Esta ação irá excluir permanentemente:
                    <ul class="mb-0 mt-2">
                        <li>A despesa parcelada "{{ despesa.descricao }}"</li>
                        <li>Todas as {{ parcelas.count }} parcelas associadas</li>
                        <li>Todos os registros de pagamento</li>
                    </ul>
                </div>
                <p class="text-muted mb-0">
                    <strong>Esta ação não pode ser desfeita.</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <form method="post" action="{% url 'excluir_despesa_parcelada' despesa.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>
                        Excluir Definitivamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pagamento -->
<div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPagamentoLabel">
                    <i class="fas fa-credit-card me-2"></i>
                    Registrar Pagamento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formPagamento" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Parcela:</label>
                        <p id="descricaoParcela" class="text-muted mb-3"></p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dataPagamento" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>
                                    Data do Pagamento *
                                </label>
                                <input type="date" class="form-control" id="dataPagamento" name="data_pagamento" required>
                                <div class="form-text">Data em que o pagamento foi realizado</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="valorPago" class="form-label">
                                    <i class="fas fa-dollar-sign me-1"></i>
                                    Valor Pago *
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="valorPago" name="valor_pago" 
                                           step="0.01" min="0.01" required>
                                </div>
                                <div class="form-text">Valor efetivamente pago (pode ser parcial)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> Se o valor pago for menor que o valor da parcela, 
                        será criada uma nova transação com o saldo restante.
                    </div>
                    
                    <div id="alertaFechamento" class="alert alert-warning d-none">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> <span id="mensagemFechamento"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>
                        Confirmar Pagamento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Reabertura -->
<div class="modal fade" id="modalReabertura" tabindex="-1" aria-labelledby="modalReaberturaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalReaberturaLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Reabertura de Parcela
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-undo fa-3x text-warning mb-3"></i>
                    <h5>Tem certeza que deseja reabrir esta parcela?</h5>
                </div>
                <p><strong>Parcela:</strong> <span id="parcelaReabertura"></span></p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Atenção:</strong> Ao reabrir esta parcela:
                    <ul class="mb-0 mt-2">
                        <li>A parcela será marcada como <strong>não paga</strong></li>
                        <li>A <strong>despesa lançada</strong> correspondente será <strong>excluída</strong> automaticamente</li>
                        <li>O saldo da conta será ajustado</li>
                    </ul>
                </div>
                <p class="text-muted mb-0">
                    <strong>Esta ação não pode ser desfeita.</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <form id="formReabertura" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-undo me-1"></i>
                        Reabrir Parcela
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let parcelaAtual = null;

function abrirModalPagamento(parcelaId, descricao, valor) {
    parcelaAtual = parcelaId;
    
    // Preencher dados da parcela
    document.getElementById('descricaoParcela').textContent = descricao;
    document.getElementById('valorPago').value = valor;
    
    // Definir data padrão como hoje (corrigido para evitar problemas de fuso horário)
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const dia = String(hoje.getDate()).padStart(2, '0');
    const dataFormatada = `${ano}-${mes}-${dia}`;
    document.getElementById('dataPagamento').value = dataFormatada;
    
    // Configurar action do form
    const actionUrl = `{% url 'processar_pagamento_parcela' 0 %}`.replace('0', parcelaId);
    document.getElementById('formPagamento').action = actionUrl;
    console.log('Form action configurado para:', actionUrl);
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalPagamento'));
    modal.show();
}

// Adicionar listener para debug do formulário
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formPagamento');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('Formulário sendo submetido para:', this.action);
            console.log('Dados do formulário:', new FormData(this));
        });
    }
});

// Validação de data em tempo real
document.getElementById('dataPagamento').addEventListener('change', function() {
    const data = this.value;
    if (data && parcelaAtual) {
        // Aqui poderia fazer uma verificação AJAX se a data está em mês fechado
        // Por enquanto, apenas uma validação básica
        const dataEscolhida = new Date(data);
        const hoje = new Date();
        
        if (dataEscolhida > hoje) {
            document.getElementById('alertaFechamento').classList.remove('d-none');
            document.getElementById('mensagemFechamento').textContent = 
                'Data de pagamento não pode ser no futuro.';
        } else {
            document.getElementById('alertaFechamento').classList.add('d-none');
        }
    }
});

function gerarParcelas(despesaId) {
    // Implementar função para gerar parcelas via AJAX
    if (confirm('Deseja tentar gerar as parcelas novamente? Esta ação pode criar parcelas duplicadas se já existirem.')) {
            window.location.href = `{% url 'gerar_parcelas_despesa' 0 %}`.replace('0', despesaId);
        }
}

function confirmarReabertura(parcelaId, descricao) {
    // Preencher dados da parcela no modal
    document.getElementById('parcelaReabertura').textContent = descricao;
    
    // Configurar action do form de reabertura
    const actionUrl = `{% url 'marcar_parcela_nao_paga' 0 %}`.replace('0', parcelaId);
    document.getElementById('formReabertura').action = actionUrl;
    
    // Abrir modal de confirmação
    const modal = new bootstrap.Modal(document.getElementById('modalReabertura'));
    modal.show();
}
</script>
{% endblock %}